<!DOCTYPE html>
<html>
<head>
    <title>Random App Name17656</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var that=this;that.calculatedFields=that._getCalculatedFields(),that.Weightings=JSON.parse(that.getSetting("Weightings")),that.ValueMappings=JSON.parse(that.getSetting("ValueMappings")),this._grid=null,this._piCombobox=this.add({xtype:"rallyportfolioitemtypecombobox",padding:5,listeners:{select:this._onPICombobox,scope:this}})},_getCalculatedFields:function(){var settingName="CalculatedField",cfs=[];for(x=1;2>=x;x++){var fieldText=this.getSetting("CalculatedField"+x),calcField={};if(!_.isUndefined(fieldText)&&!_.isNull(fieldText)&&""!=fieldText){var parts=fieldText.split(",");calcField.field=parts[0],calcField.formula=parts[1],cfs.push(calcField)}}return cfs},_getWeightings:function(){return this.Weightings},_getValueMappings:function(){return this.ValueMappings},_isMappableField:function(fieldName,record){var value=record.get(fieldName);return _.isNull(value)||""==value||_.isNumber(value)||!_.isNaN(parseInt(""+value))?!1:!0},_mapValue:function(value,field){var mappings=this._getValueMappings(),key=_.has(mappings,field)?field:"default",mapping=mappings[key];return _.has(mapping,value)?mapping[value]:0},_applyWeigthing:function(fieldName,value){var weightings=this._getWeightings(),weight=1;return _.has(weightings,fieldName)&&(weight=weightings[fieldName]),weight*value},_calcValue:function(record,calcField){var that=this,regex=/\w{2,50}/g,replacer=function(fieldName){var value;return value=that._isMappableField(fieldName,record)?that._mapValue(record.get(fieldName),fieldName):record.get(fieldName),that._applyWeigthing(fieldName,value)},formula=calcField.formula.replace(regex,replacer),value;try{value=eval(formula),value=_.isNumber(value)&&!_.isNaN(value)&&_.isFinite(value)?value:0,console.log("formula:",formula,"value",value)}catch(e){return{value:0,error:e.message}}return{value:Math.round(100*value)/100,error:null}},_onPICombobox:function(){var selectedType=this._piCombobox.getRecord(),model=selectedType.get("TypePath"),that=this;null!==this._grid&&this._grid.destroy(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[model],listeners:{update:function(store,rec,modified,opts){"edit"!=modified||1!=opts.length||_.contains(_.pluck(that.calculatedFields,"field"),opts[0])||this._calculateScore([rec])},scope:this},enableHierarchy:!0}).then({success:function(store,records){var that=this,selectedType=this._piCombobox.getRecord(),modelNames=selectedType.get("TypePath");Rally.data.ModelFactory.getModel({type:modelNames,success:function(model){that._onStoreBuilt(store,records,model)}})},scope:this})},_onStoreBuilt:function(store,records,model){var diffFields=this._allFieldsValid(model);if(diffFields.length>0)return Ext.Msg.alert("Status","Invalid fields in formula:"+diffFields),void 0;var selectedType=this._piCombobox.getRecord(),modelNames=selectedType.get("TypePath"),columns=["Name"],context=this.getContext();this._grid=this.add({xtype:"rallygridboard",context:context,modelNames:[modelNames],toggleState:"grid",stateful:!1,plugins:[{ptype:"rallygridboardcustomfiltercontrol",filterChildren:!1,filterControlConfig:{modelNames:[modelNames],stateful:!0,stateId:context.getScopedStateId("custom-filter-example")}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[modelNames],stateful:!0,stateId:context.getScopedStateId("columns-example")},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:function(){window.location=Rally.ui.grid.GridCsvExport.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export"}}],gridConfig:{store:store,columnCfgs:columns},height:this.getHeight()})},_allFieldsValid:function(model){var validFields=_.map(model.getFields(),function(f){return f.name}),allFields=[],that=this;_.each(this.calculatedFields,function(cf){allFields.push(cf.field),allFields=allFields.concat(_getFormulaFields(cf.formula))}),allFields=_.uniq(allFields);var diff=_.difference(allFields,validFields);return diff},_allFieldsSet:function(fields,feature){var allSet=!0;return _.each(fields,function(field){var value=feature.get(field);(_.isNull(value)||_.isUndefined(value)||""==value)&&(allSet=!1)}),allSet},_calculateScore:function(records){var that=this;Ext.Array.each(records,function(feature){console.log(feature.get("FormattedID")),_.each(that.calculatedFields,function(calcField){var fields=_getFormulaFields(calcField.formula);if(that._allFieldsSet(fields,feature)){var oldValue=feature.get(calcField.field),value=that._calcValue(feature,calcField);_.isNull(value.error)?_.isNull(value.value)||value.value===oldValue||feature.set(calcField.field,value.value):console.log("formula error:",value.error)}else feature.set(calcField.field,0)})})},getSettingsFields:function(){var values=[{name:"CalculatedField1",width:800,xtype:"rallytextfield",label:"Calculated Field 1",labelWidth:200},{name:"CalculatedField2",width:800,xtype:"rallytextfield",label:"Calculated Field 2",labelWidth:200},{name:"ValueMappings",width:800,xtype:"textareafield",grow:!0,label:"Field Value Mappings",labelWidth:200},{name:"Weightings",width:800,xtype:"textareafield",grow:!0,label:"Field Value Weightings",labelWidth:200}];return values},config:{defaultSettings:{ValueMappings:_getValueMappingsString(),Weightings:_getWeightingsString(),CalculatedField1:"",CalculatedField2:""}}});
                function _getFormulaFields(formula){var regex=/\w{2,50}/g,m,fields=[];do m=regex.exec(formula),m&&fields.push(m[0]);while(m);return fields}function _getValueMappingsString(){return'{\n            "default" : {\n                "NA" : 0,\n                "L" : 1,\n                "M" : 5,\n                "H" : 10\n            },\n            "c_RiskFactorOfNotDoing" : {\n                "NA" : 0,\n                "L"  : 5,\n                "M"  : 10,\n                "H"  : 25\n            },\n            "c_Foundational" : {\n                "NA" : 0,\n                "L"  : 5,\n                "M"  : 10,\n                "H"  : 25\n            },\n            "c_BusinessLevelOfEffort" : {\n                "NA" :  0,\n                "XS" :  1,\n                "S"  :  2,\n                "M"  :  3,\n                "L"  :  5,\n                "XL" :  8\n            },\n            "c_ITLevelOfEffort" : {\n                "NA" :  0,\n                "XS" :  1,\n                "S"  :  2,\n                "M"  :  3,\n                "L"  :  5,\n                "XL" :  8\n            }\n        }\n'}function _getWeightingsString(){return'{\n            "c_SalesProfitability" : 4.8,\n            "c_CostSavings" : 1.7,\n            "c_CustomerExperience" : 3.4,\n            "c_AgentExperience" : 2.2,\n            "c_RiskMitigationCompliance" : 2.9,\n            "c_Urgency" : 1,\n            "c_RiskFactorOfNotDoing" : 1,\n            "c_Foundational" : 1\n        }\n'}

            Rally.launchApp('CustomApp', {
                name:"Random App Name17656",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
