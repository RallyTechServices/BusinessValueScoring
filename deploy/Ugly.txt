<!DOCTYPE html>
<html>
<head>
    <title>CATS-Business Value Scoring App-0.1</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue Jul 03 2018 10:33:41 GMT-0700 (PDT) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue Jul 03 2018 10:33:41 GMT-0700 (PDT)";
        var ARTIFACT = "US2503";
        var BUILDER  = "rajan08";
        var CHECKSUM = 6745424209;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            function _getDefaultColumns(){return["c_SalesProfitability","c_CostSavings","c_CustomerExperience","c_AgentExperience","c_RiskMitigationCompliance","c_Urgency","c_RiskFactorOfNotDoing","c_Foundational","c_TShirtSizeBusiness","c_TShirtSizeIT","c_BusinessValueScore","c_CustomWSJFScore","c_CategoryEpicOnly"]}function _getFormulaFields(a){var b,c=/\w{2,50}/g,d=[];do b=c.exec(a),b&&d.push(b[0]);while(b);return d}function _getValueMappingsString(){return'{\n            "default" : {\n                "NA" : 0,\n                "L" : 1,\n                "M" : 5,\n                "H" : 10\n            },\n            "c_RiskFactorOfNotDoing" : {\n                "NA" : 0,\n                "L"  : 5,\n                "M"  : 10,\n                "H"  : 25\n            },\n            "c_Foundational" : {\n                "NA" : 0,\n                "L"  : 5,\n                "M"  : 10,\n                "H"  : 25\n            },\n            "c_BusinessLevelOfEffort" : {\n                "NA" :  0,\n                "XS" :  1,\n                "S"  :  2,\n                "M"  :  3,\n                "L"  :  5,\n                "XL" :  8\n            },\n            "c_ITLevelOfEffort" : {\n                "NA" :  0,\n                "XS" :  1,\n                "S"  :  2,\n                "M"  :  3,\n                "L"  :  5,\n                "XL" :  8\n            }\n        }\n'}function _getWeightingsString(){return'{\n            "c_SalesProfitability" : 4.8,\n            "c_CostSavings" : 1.7,\n            "c_CustomerExperience" : 3.4,\n            "c_AgentExperience" : 2.2,\n            "c_RiskMitigationCompliance" : 2.9,\n            "c_Urgency" : 1,\n            "c_RiskFactorOfNotDoing" : 1,\n            "c_Foundational" : 1\n        }\n'}Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,showLog:!1,logger:null,items:[{xtype:"container",itemId:"information"},{xtype:"container",itemId:"button_box"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}this.showLog&&this.logger&&this.down("#button_box").add({xtype:"rallybutton",text:"Show Log",listeners:{scope:this,click:function(){this.logger.displayLog()}}}),a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,dock:"bottom"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);ARTIFACT&&(a=a+"<br/>Source artifact: "+ARTIFACT),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"top",html:a})}}}),Ext.define("CArABU.technicalservices.Logger",{saveForLater:!1,saveLines:100,logArray:[],constructor:function(a){Ext.apply(this,a)},setSaveForLater:function(a){this.saveForLater=a},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),this.saveForLater&&(this.logArray||(this.logArray=[]),this.logArray.push(c.join(" ")),this.logArray.length>this.saveLines&&this.logArray.shift()),window.console&&console.log.apply(console,c)},getLogText:function(){return this.logArray&&0!==this.logArray.length?this.logArray.join("<br/>"):"-- no log --"},displayLog:function(){var a=this.getLogText();this.popup=Ext.create("Rally.ui.dialog.Dialog",{width:Ext.getBody().getWidth()-20,height:Ext.getBody().getHeight()-20,closable:!0,title:"Log",autoShow:!0,layout:"border",defaults:{layout:"fit",width:"50%",border:!1},items:[{region:"center",xtype:"container",html:a,autoScroll:!0}]})}}),Ext.define("TSUtilities",{singleton:!0,loadWsapiRecords:function(a){var b=Ext.create("Deft.Deferred"),c={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(c,a)).load({callback:function(a,c,d){d?b.resolve(a):(console.error("Failed: ",c),b.reject("Problem loading: "+c.error.errors.join(". ")))}}),b.promise},loadAStoreWithAPromise:function(a,b){var c=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:a,fetch:b}).load({callback:function(a,b,d){d?c.resolve(this):(console.error("Failed: ",b),c.reject("Problem loading: "+b.error.errors.join(". ")))}}),c.promise}}),Ext.define("CArABU.app.TSApp",{extend:"Rally.app.App",componentCls:"app",logger:new CArABU.technicalservices.Logger,items:[{xtype:"container",flex:1,itemId:"selector_box",layout:"hbox"},{xtype:"container",flex:1,itemId:"grid_box"}],launch:function(){var a=this;a.calculatedFields=a._getCalculatedFields(),a.Weightings=JSON.parse(a.getSetting("Weightings")),a.ValueMappings=JSON.parse(a.getSetting("ValueMappings")),this._grid=null,this._piCombobox=this.down("#selector_box").add({xtype:"rallyportfolioitemtypecombobox",padding:5,listeners:{select:this._onPICombobox,scope:this}}),this.down("#selector_box").add({xtype:"rallybutton",text:"Recalculate",padding:5,listeners:{click:this._recalculate,scope:this}})},_recalculate:function(){var a=this,b=this._piCombobox.getRecord(),c=b.get("TypePath"),d={model:c,fetch:["Name"].concat(_getDefaultColumns()),limit:1/0};a.setLoading(!0),a.loadWsapiRecords(d).then({success:function(b){a._calculateScore(b,!0),a._onPICombobox(),Rally.ui.notify.Notifier.show({message:"Recalculated!"}),a.setLoading(!1),setTimeout(function(){Rally.ui.notify.Notifier.hide()},3e3)},failure:function(b){a.setLoading(!1),deferred.reject(b)},scope:a})},_getCalculatedFields:function(){var a=[];for(x=1;x<=2;x++){var b=this.getSetting("CalculatedField"+x),c={};if(!_.isUndefined(b)&&!_.isNull(b)&&""!=b){var d=b.split(",");c.field=d[0],c.formula=d[1],a.push(c)}}return a},_getWeightings:function(){return this.Weightings},_getValueMappings:function(){return this.ValueMappings},_isMappableField:function(a,b){var c=b.get(a);return _.isNull(c)||""==c||_.isNumber(c)||!_.isNaN(parseInt(""+c))?!1:!0},_mapValue:function(a,b){var c=this._getValueMappings(),d=_.has(c,b)?b:"default",e=c[d];return _.has(e,a)?e[a]:0},_applyWeigthing:function(a,b){var c=this._getWeightings(),d=1;return _.has(c,a)&&(d=c[a]),d*b},_calcValue:function(record,calcField){var that=this,regex=/\w{2,50}/g,replacer=function(a){var b;return b=that._isMappableField(a,record)?that._mapValue(record.get(a),a):record.get(a),that._applyWeigthing(a,b)},formula=calcField.formula.replace(regex,replacer),value;try{value=eval(formula),value=_.isNumber(value)&&!_.isNaN(value)&&_.isFinite(value)?value:0,console.log("formula:",formula,"value",value)}catch(e){return{value:0,error:e.message}}return{value:Math.round(100*value)/100,error:null}},_onPICombobox:function(){var a=this._piCombobox.getRecord(),b=a.get("TypePath"),c=this;null!==this._grid&&this._grid.destroy(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[b],listeners:{update:function(a,b,d,e){"edit"!=d||1!=e.length||_.contains(_.pluck(c.calculatedFields,"field"),e[0])||this._calculateScore([b])},scope:this},enableHierarchy:!0}).then({success:function(a,b){var c=this,d=this._piCombobox.getRecord(),e=d.get("TypePath");Rally.data.ModelFactory.getModel({type:e,success:function(d){c._onStoreBuilt(a,b,d)}})},scope:this})},_onStoreBuilt:function(a,b,c){var d=this._allFieldsValid(c);if(d.length>0)return void Ext.Msg.alert("Status","Invalid fields in formula:"+d);var e=this._piCombobox.getRecord(),f=e.get("TypePath"),g=["Name"].concat(_getDefaultColumns()),h=this.getContext();this._grid=this.down("#grid_box").add({xtype:"rallygridboard",context:h,modelNames:[f],toggleState:"grid",stateful:!1,plugins:[{ptype:"rallygridboardcustomfiltercontrol",filterChildren:!1,filterControlConfig:{modelNames:[f],stateful:!0,stateId:h.getScopedStateId("custom-filter-example")}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[f],stateful:!0,stateId:h.getScopedStateId("columns-example")},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:function(){window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(this._grid.getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export"}}],gridConfig:{store:a,columnCfgs:g},height:this.getHeight()})},_allFieldsValid:function(a){var b=_.map(a.getFields(),function(a){return a.name}),c=[];_.each(this.calculatedFields,function(a){c.push(a.field),c=c.concat(_getFormulaFields(a.formula))}),c=_.uniq(c);var d=_.difference(c,b);return d},_allFieldsSet:function(a,b){var c=!0;return _.each(a,function(a){var d=b.get(a);(_.isNull(d)||_.isUndefined(d)||""==d)&&(console.log("Missing Field Value:'"+a+"'"),c=!1)}),c},_setCategory:function(a,b){var c=null;b>=0&&10>b?c="5":b>=10&&20>b?c="4":b>=20&&30>b?c="3":b>=30&&50>b?c="2":b>=50&&(c="1"),c&&a.set("c_CategoryEpicOnly",c)},_calculateScore:function(a,b){this.setLoading(!0);var c=this;Ext.Array.each(a,function(a){console.log(a.get("FormattedID")),_.each(c.calculatedFields,function(b){var d=_getFormulaFields(b.formula);if(c._allFieldsSet(d,a)){var e=a.get(b.field),f=c._calcValue(a,b);_.isNull(f.error)?(_.isNull(f.value)||f.value===e||a.set(b.field,f.value),"c_BusinessValueScore"==b.field&&c._setCategory(a,f.value)):console.log("formula error:",f.error)}else a.set(b.field,0)}),b&&a.save()}),this.setLoading(!1)},loadWsapiRecords:function(a,b){var c=Ext.create("Deft.Deferred"),d={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(d,a)).load({callback:function(a,d,e){e?b?c.resolve(d):c.resolve(a):c.reject("Problem loading: "+d.error.errors.join(". "))}}),c.promise},getSettingsFields:function(){var a=[{name:"CalculatedField1",width:800,xtype:"rallytextfield",label:"Calculated Field 1",labelWidth:200},{name:"CalculatedField2",width:800,xtype:"rallytextfield",label:"Calculated Field 2",labelWidth:200},{name:"ValueMappings",width:800,xtype:"textareafield",grow:!0,label:"Field Value Mappings",labelWidth:200},{name:"Weightings",width:800,xtype:"textareafield",grow:!0,label:"Field Value Weightings",labelWidth:200}];return a},config:{defaultSettings:{ValueMappings:_getValueMappingsString(),Weightings:_getWeightingsString(),CalculatedField1:"c_BusinessValueScore,(c_SalesProfitability + c_CostSavings + c_CustomerExperience + c_AgentExperience + c_RiskMitigationCompliance + c_Urgency + c_RiskFactorOfNotDoing + c_Foundational)",CalculatedField2:"c_CustomWSJFScore,(c_BusinessValueScore / (c_TShirtSizeBusiness+c_TShirtSizeIT))"}}});

               Rally.launchApp('CArABU.app.TSApp', {
                   name: 'Business Value Scoring App'
               });
        });
    </script>

    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>